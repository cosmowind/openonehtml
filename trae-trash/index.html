<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenOneHTML - HTMLæ–‡ä»¶ç®¡ç†ç³»ç»Ÿ</title>
    
    <!-- CSSæ–‡ä»¶ -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/stats-panel.css">
    <link rel="stylesheet" href="css/search-panel.css">
    <link rel="stylesheet" href="css/file-list.css">
    <link rel="stylesheet" href="css/modal.css">
    
    <!-- å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- åŠ è½½é®ç½© -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨åŠ è½½...</div>
    </div>
    
    <!-- å¤´éƒ¨ -->
    <header class="header">
        <div class="header-container">
            <div class="header-logo">
                <i class="fas fa-code"></i>
                <span>OpenOneHTML</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary refresh-btn" onclick="app.refresh()">
                    <i class="fas fa-sync-alt"></i> åˆ·æ–°
                </button>
                <button class="btn btn-settings settings-btn" onclick="showSettings()">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </header>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content">
        <div class="container">
            <!-- ç»Ÿè®¡é¢æ¿ -->
            <section id="statsPanel" class="stats-panel">
                <div class="stats-container">
                    <div class="stat-card" data-type="total-files">
                        <div class="stat-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">0</div>
                            <div class="stat-label">æ–‡ä»¶æ€»æ•°</div>
                        </div>
                    </div>
                    <div class="stat-card" data-type="categories">
                        <div class="stat-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">0</div>
                            <div class="stat-label">åˆ†ç±»æ•°é‡</div>
                        </div>
                    </div>
                    <div class="stat-card" data-type="tags">
                        <div class="stat-icon">
                            <i class="fas fa-tags"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">0</div>
                            <div class="stat-label">æ ‡ç­¾æ•°é‡</div>
                        </div>
                    </div>
                    <div class="stat-card" data-type="models">
                        <div class="stat-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">0</div>
                            <div class="stat-label">æ¨¡å‹æ•°é‡</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- æœç´¢é¢æ¿ -->
            <section id="searchPanel" class="search-panel">
                <div class="search-container">
                    <div class="search-input-group">
                        <input 
                            type="text" 
                            id="searchInput" 
                            class="search-input" 
                            placeholder="æœç´¢æ–‡ä»¶åç§°ã€åœºæ™¯æˆ–æè¿°..."
                        >
                        <button id="searchBtn" class="btn btn-primary">
                            <i class="fas fa-search"></i> æœç´¢
                        </button>
                        <button id="resetSearchBtn" class="btn btn-secondary">
                            <i class="fas fa-times"></i> é‡ç½®
                        </button>
                    </div>
                    
                    <div class="filter-group">
                        <div class="filter-item">
                            <label for="categoryFilter">åˆ†ç±»:</label>
                            <select id="categoryFilter" class="filter-select">
                                <option value="">å…¨éƒ¨åˆ†ç±»</option>
                            </select>
                        </div>
                        
                        <div class="filter-item">
                            <label for="tagFilter">æ ‡ç­¾:</label>
                            <select id="tagFilter" class="filter-select" multiple>
                            </select>
                        </div>
                        
                        <div class="filter-item">
                            <label for="modelFilter">æ¨¡å‹:</label>
                            <select id="modelFilter" class="filter-select" multiple>
                            </select>
                        </div>
                    </div>
                    
                    <div class="search-actions">
                        <button id="tagManagerBtn" class="btn btn-outline">
                            <i class="fas fa-tags"></i> ç®¡ç†æ ‡ç­¾
                        </button>
                        <button id="modelManagerBtn" class="btn btn-outline">
                            <i class="fas fa-robot"></i> ç®¡ç†æ¨¡å‹
                        </button>
                    </div>
                    
                    <div id="searchResultsCount" class="search-results-count">
                        æœç´¢ç»“æœ: 0 ä¸ªæ–‡ä»¶
                    </div>
                </div>
            </section>
            
            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <section id="fileList" class="file-list">
                <div class="file-list-container" style="display: grid !important; grid-template-columns: repeat(3, 1fr) !important; gap: 20px;">
                    <!-- æ–‡ä»¶å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </section>
        </div>
    </main>
    
    <!-- æ–‡ä»¶å¡ç‰‡æ¨¡æ¿ -->
    <template id="fileCardTemplate">
        <div class="file-card" style="width: 100%; height: auto;">
            <div class="file-card-header">
                <h3 class="file-name"></h3>
                <div class="file-actions">
                    <button class="btn btn-sm btn-primary view-btn">
                        <i class="fas fa-eye"></i> æŸ¥çœ‹
                    </button>
                    <button class="btn btn-sm btn-secondary edit-btn">
                        <i class="fas fa-edit"></i> ç¼–è¾‘
                    </button>
                    <button class="btn btn-sm btn-danger delete-btn">
                        <i class="fas fa-trash"></i> åˆ é™¤
                    </button>
                </div>
            </div>
            <div class="file-card-body">
                <div class="file-info">
                    <div class="info-item">
                        <span class="info-label">åœºæ™¯:</span>
                        <span class="info-value"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">åˆ†ç±»:</span>
                        <span class="info-value"></span>
                    </div>
                </div>
                <div class="file-tags"></div>
                <div class="file-models"></div>
                <div class="file-description"></div>
            </div>
            <div class="file-card-footer">
                <div class="file-meta">
                    <span class="meta-item"></span>
                    <span class="meta-item"></span>
                </div>
            </div>
        </div>
    </template>
    
    <!-- ç¼–è¾‘æ–‡ä»¶æ¨¡æ€æ¡† -->
    <div id="editFileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç¼–è¾‘æ–‡ä»¶</h2>
                <button class="close-btn" onclick="uiManager.getComponent('modalManager').closeModal('editFileModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="editFileForm">
                    <input type="hidden" id="editFileId">
                    
                    <div class="form-group">
                        <label for="editFileName">æ–‡ä»¶åç§°:</label>
                        <input type="text" id="editFileName" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editScene">åœºæ™¯:</label>
                        <input type="text" id="editScene" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="editDescription">æè¿°:</label>
                        <textarea id="editDescription" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editTagsSelect">æ ‡ç­¾:</label>
                        <select id="editTagsSelect" class="form-control" multiple>
                        </select>
                        <div class="form-help">æŒ‰ä½Ctrlé”®å¯é€‰æ‹©å¤šä¸ªæ ‡ç­¾</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="newTagInput">æ·»åŠ æ–°æ ‡ç­¾:</label>
                        <input type="text" id="newTagInput" class="form-control" placeholder="è¾“å…¥æ–°æ ‡ç­¾ï¼Œå¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”">
                    </div>
                    
                    <div class="form-group">
                        <label for="editModelsSelect">æ¨¡å‹:</label>
                        <select id="editModelsSelect" class="form-control" multiple>
                        </select>
                        <div class="form-help">æŒ‰ä½Ctrlé”®å¯é€‰æ‹©å¤šä¸ªæ¨¡å‹</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="newModelInput">æ·»åŠ æ–°æ¨¡å‹:</label>
                        <input type="text" id="newModelInput" class="form-control" placeholder="è¾“å…¥æ–°æ¨¡å‹ï¼Œå¤šä¸ªæ¨¡å‹ç”¨é€—å·åˆ†éš”">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="uiManager.getComponent('modalManager').closeModal('editFileModal')">
                    å–æ¶ˆ
                </button>
                <button class="btn btn-primary" onclick="saveFileChanges()">
                    ä¿å­˜
                </button>
            </div>
        </div>
    </div>
    
    <!-- åˆ é™¤æ–‡ä»¶æ¨¡æ€æ¡† -->
    <div id="deleteFileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">åˆ é™¤æ–‡ä»¶</h2>
                <button class="close-btn" onclick="uiManager.getComponent('modalManager').closeModal('deleteFileModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ <strong id="deleteFileName"></strong> å—ï¼Ÿ</p>
                <p class="text-warning">æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
                <input type="hidden" id="deleteFileId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="uiManager.getComponent('modalManager').closeModal('deleteFileModal')">
                    å–æ¶ˆ
                </button>
                <button class="btn btn-danger" onclick="confirmDeleteFile()">
                    åˆ é™¤
                </button>
            </div>
        </div>
    </div>
    
    <!-- é¢„ç½®é€‰é¡¹ç®¡ç†å™¨æ¨¡æ€æ¡† -->
    <div id="presetManagerModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2 class="modal-title">é¢„ç½®é€‰é¡¹ç®¡ç†</h2>
                <button class="close-btn" onclick="uiManager.getComponent('modalManager').closeModal('presetManagerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="preset-manager-container">
                    <div class="preset-manager-header">
                        <div class="preset-manager-tabs">
                            <button class="tab-btn active" onclick="switchPresetTab('tags')">æ ‡ç­¾ç®¡ç†</button>
                            <button class="tab-btn" onclick="switchPresetTab('models')">æ¨¡å‹ç®¡ç†</button>
                        </div>
                        <button class="btn btn-primary" onclick="addNewPreset()">
                            <i class="fas fa-plus"></i> æ·»åŠ æ–°é¡¹
                        </button>
                    </div>
                    
                    <div class="preset-manager-content">
                        <div id="presetManagerList" class="preset-manager-list">
                            <!-- é¢„ç½®é€‰é¡¹åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="uiManager.getComponent('modalManager').closeModal('presetManagerModal')">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>
    
    <!-- JavaScriptæ–‡ä»¶ -->
    <script src="js/data-manager.js"></script>
    <script src="js/preset-manager.js"></script>
    <script src="js/ui-manager.js"></script>
    <script src="js/components.js"></script>
    <script src="js/app.js"></script>


    <!-- å¼ºåˆ¶æ ·å¼è¦†ç›– -->
    <style>
        /* å¼ºåˆ¶ç¡®ä¿ç½‘æ ¼å¸ƒå±€ */
        .file-list-container {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 20px !important;
        }

        /* å¼ºåˆ¶ç¡®ä¿å¡ç‰‡æ ·å¼ */
        .file-card {
            width: 100% !important;
            height: auto !important;
            display: flex !important;
            flex-direction: column !important;
        }

        /* åœ¨å¤§å±å¹•ä¸Šç¡®ä¿3åˆ— */
        @media (min-width: 1200px) {
            .file-list-container {
                grid-template-columns: repeat(3, 1fr) !important;
            }
        }

        /* åœ¨ä¸­ç­‰å±å¹•ä¸Šç¡®ä¿2åˆ— */
        @media (max-width: 1199px) and (min-width: 768px) {
            .file-list-container {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        /* åœ¨å°å±å¹•ä¸Šç¡®ä¿1åˆ— */
        @media (max-width: 768px) {
            .file-list-container {
                grid-template-columns: 1fr !important;
            }
        }
    </style>

    <!-- è°ƒè¯•ä»£ç  -->
    <script>
        // æ·»åŠ è°ƒè¯•é¢æ¿
        function addDebugPanel() {
            const debugPanel = document.createElement('div');
            debugPanel.id = 'debug-panel';
            debugPanel.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 15px;
                border-radius: 8px;
                font-size: 12px;
                z-index: 9999;
                max-width: 300px;
                font-family: monospace;
            `;

            document.body.appendChild(debugPanel);

            function updateDebug() {
                const container = document.querySelector('.file-list-container');
                const cards = document.querySelectorAll('.file-card');

                if (!container || cards.length === 0) {
                    debugPanel.innerHTML = 'ç­‰å¾…å…ƒç´ åŠ è½½...';
                    return;
                }

                const containerStyle = getComputedStyle(container);
                const firstCardStyle = getComputedStyle(cards[0]);

                debugPanel.innerHTML = `
                    <div style="margin-bottom: 10px; font-weight: bold;">ğŸ” å¸ƒå±€è°ƒè¯•ä¿¡æ¯</div>

                    <div style="margin-bottom: 8px;">
                        <strong>å®¹å™¨:</strong><br>
                        æ˜¾ç¤º: ${containerStyle.display}<br>
                        ç½‘æ ¼åˆ—: ${containerStyle.gridTemplateColumns}<br>
                        å®½åº¦: ${container.offsetWidth}px
                    </div>

                    <div style="margin-bottom: 8px;">
                        <strong>å¡ç‰‡:</strong><br>
                        æ•°é‡: ${cards.length}<br>
                        æ˜¾ç¤º: ${firstCardStyle.display}<br>
                        å®½åº¦: ${cards[0].offsetWidth}px<br>
                        é«˜åº¦: ${cards[0].offsetHeight}px<br>
                        Flexå±æ€§: ${firstCardStyle.flexShrink}/${firstCardStyle.flexGrow}
                    </div>

                    <div style="margin-bottom: 8px;">
                        <strong>å¸ƒå±€çŠ¶æ€:</strong><br>
                        ${containerStyle.display === 'grid' ? 'âœ… ç½‘æ ¼å¸ƒå±€æ­£å¸¸' : 'âŒ ç½‘æ ¼å¸ƒå±€å¤±æ•ˆ'}<br>
                        ${containerStyle.gridTemplateColumns.includes('1fr') ? 'âœ… ç½‘æ ¼åˆ—è®¾ç½®æ­£ç¡®' : 'âŒ ç½‘æ ¼åˆ—è®¾ç½®é”™è¯¯'}<br>
                        ${cards[0].offsetWidth < container.offsetWidth * 0.5 ? 'âœ… å¡ç‰‡å®½åº¦é€‚ä¸­' : 'âŒ å¡ç‰‡å®½åº¦è¿‡å¤§'}<br>
                        ${firstCardStyle.height === 'auto' ? 'âœ… é«˜åº¦è‡ªé€‚åº”' : 'âŒ é«˜åº¦å›ºå®š'}
                    </div>
                `;
            }

            updateDebug();
            setInterval(updateDebug, 1000);
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ·»åŠ è°ƒè¯•é¢æ¿
        window.addEventListener('load', function() {
            console.log('=== æ·»åŠ è°ƒè¯•é¢æ¿ ===');
            addDebugPanel();
        });
    </script>

    <!-- å…¨å±€å‡½æ•° -->
    <script>
        // æ˜¾ç¤ºè®¾ç½®
        function showSettings() {
            alert('è®¾ç½®åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
        }
        
        // ä¿å­˜æ–‡ä»¶æ›´æ”¹
        function saveFileChanges() {
            const fileId = document.getElementById('editFileId').value;
            const fileName = document.getElementById('editFileName').value;
            const scene = document.getElementById('editScene').value;
            const description = document.getElementById('editDescription').value;
            
            if (!fileId || !fileName) {
                alert('è¯·å¡«å†™æ–‡ä»¶åç§°');
                return;
            }
            
            // è·å–é€‰ä¸­çš„æ ‡ç­¾
            const selectedTags = presetManager.getSelectedTags();
            
            // è·å–é€‰ä¸­çš„æ¨¡å‹
            const selectedModels = presetManager.getSelectedModels();
            
            // æ›´æ–°æ–‡ä»¶
            const updateData = {
                name: fileName,
                scene: scene,
                description: description,
                tags: selectedTags,
                models: selectedModels
            };
            
            dataManager.updateFile(fileId, updateData)
                .then(() => {
                    uiManager.getComponent('modalManager').closeModal('editFileModal');
                    uiManager.showMessage('æ–‡ä»¶æ›´æ–°æˆåŠŸ', 'success');
                })
                .catch(error => {
                    console.error('Failed to save file changes:', error);
                    uiManager.showMessage('æ–‡ä»¶æ›´æ–°å¤±è´¥', 'error');
                });
        }
        
        // ç¡®è®¤åˆ é™¤æ–‡ä»¶
        function confirmDeleteFile() {
            const fileId = document.getElementById('deleteFileId').value;
            
            if (!fileId) {
                alert('æ— æ•ˆçš„æ–‡ä»¶ID');
                return;
            }
            
            dataManager.deleteFile(fileId)
                .then(() => {
                    uiManager.getComponent('modalManager').closeModal('deleteFileModal');
                    uiManager.showMessage('æ–‡ä»¶åˆ é™¤æˆåŠŸ', 'success');
                })
                .catch(error => {
                    console.error('Failed to delete file:', error);
                    uiManager.showMessage('æ–‡ä»¶åˆ é™¤å¤±è´¥', 'error');
                });
        }
        
        // åˆ‡æ¢é¢„ç½®é€‰é¡¹æ ‡ç­¾
        function switchPresetTab(type) {
            const modal = document.getElementById('presetManagerModal');
            modal.setAttribute('data-type', type);
            
            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            const tabBtns = modal.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = Array.from(tabBtns).find(btn => 
                btn.textContent.includes(type === 'tags' ? 'æ ‡ç­¾' : 'æ¨¡å‹')
            );
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // æ›´æ–°åˆ—è¡¨
            presetManager.populateManagerList(type);
        }
        
        // æ·»åŠ æ–°é¢„ç½®é€‰é¡¹
        function addNewPreset() {
            const modal = document.getElementById('presetManagerModal');
            const type = modal.getAttribute('data-type') || 'tags';
            
            const name = prompt(`è¯·è¾“å…¥æ–°çš„${type === 'tags' ? 'æ ‡ç­¾' : 'æ¨¡å‹'}åç§°:`);
            if (!name) return;
            
            if (type === 'tags') {
                if (presetManager.addTag(name)) {
                    presetManager.populateManagerList(type);
                    uiManager.showMessage('æ ‡ç­¾æ·»åŠ æˆåŠŸ', 'success');
                } else {
                    uiManager.showMessage('æ ‡ç­¾æ·»åŠ å¤±è´¥', 'error');
                }
            } else {
                if (presetManager.addModel(name)) {
                    presetManager.populateManagerList(type);
                    uiManager.showMessage('æ¨¡å‹æ·»åŠ æˆåŠŸ', 'success');
                } else {
                    uiManager.showMessage('æ¨¡å‹æ·»åŠ å¤±è´¥', 'error');
                }
            }
        }
    </script>
</body>
</html>